---

slurm_upgrade: false
slurm_roles: []
slurm_partitions: []
slurm_nodes: []

slurm_config_dir: "{{ '/etc/slurm' if __slurm_debian else '/etc/slurm' }}"

slurm_create_user: "{{ __slurm_redhat }}"
slurm_create_dirs: "{{ __slurm_redhat }}"
slurm_rotate_logs: "{{ __slurm_redhat }}"
slurm_configure_munge: true

# Service names are the same on both distros since ??
slurmd_service_name: slurmd
slurmctld_service_name: slurmctld
slurmdbd_service_name: slurmdbd

slurm_start_services: true

__slurm_user_name: "{{ (slurm_user | default({})).name | default('slurm') }}"
# TODO: this could be incorrect, use the group collection from galaxyproject.galaxy
__slurm_group_name: "{{ (slurm_user | default({})).group | default(omit) }}"

__slurm_debian: "{{ ansible_os_family == 'Debian' }}"
__slurm_redhat: "{{ ansible_os_family == 'RedHat' }}"

__slurm_config_default:
  AuthType: auth/munge
  CryptoType: crypto/munge
  SlurmUser: "{{ __slurm_user_name }}"
  ClusterName: cluster
  # default is proctrack/cgroup which is the best but also less than 100% chance of working e.g. in docker
  ProctrackType: proctrack/cgroup
  # slurmctld options
  SlurmctldPort: 6817
  SlurmctldLogFile: "{{ '/var/log/slurm/slurmctld.log' if __slurm_debian else omit }}"
  SlurmctldPidFile: '/run/slurmctld.pid' 
  StateSaveLocation: '/var/lib/slurm/slurmctld'
  # slurmd options
  SlurmdPort: 6818
  SlurmdLogFile: '/var/log/slurm/slurmd.log'
  SlurmdPidFile: '/run/slurmd.pid'
  SlurmdSpoolDir: '/var/lib/slurm'
  JobAcctGatherType: jobacct_gather/cgroup
  AccountingStorageType: accounting_storage/slurmdbd

__slurm_config_merged: "{{ __slurm_config_default | combine(slurm_config | default({})) }}"

__slurm_debian_packages:
  client: [slurm-client, slurm-wlm-doc]
  slurmctld: [slurm-wlm]
  slurmd: [slurm-wlm]
  slurmdbd: [slurmdbd]

__slurm_redhat_packages:
  client: [slurm, munge]
  slurmctld: [munge, slurm, slurm-slurmctld]
  slurmd: [munge, slurm, slurm-slurmd]
  slurmdbd: [munge, slurm-slurmdbd]

__slurm_packages: "{{ __slurm_debian_packages if __slurm_debian else __slurm_redhat_packages }}"

__slurmdbd_config_default:
  AuthType: auth/munge
  DbdPort: 6819
  DbdHost: localhost
  StorageUser: slurm
  StoragePass: aI4]MVHt21PIBp1g
  StorageType: accounting_storage/mysql
  StorageHost: cluster-01.db.srv.science.upjs.sk
  SlurmUser: "{{ __slurm_user_name }}"
  PidFile: /run/slurmdbd.pid
  LogFile: '/var/log/slurm/slurmdbd.log'
__slurmdbd_config_merged: "{{ __slurmdbd_config_default | combine(slurmdbd_config | default({})) }}"
